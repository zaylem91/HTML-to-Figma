<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HTML to Figma</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background-color: #ffffff;
        color: #333333;
        font-size: 12px;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
      }

      h2 {
        font-size: 16px;
        margin-bottom: 16px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 12px;
        font-weight: 500;
      }

      .textarea-wrapper {
        position: relative;
      }

      textarea {
        width: 100%;
        padding: 8px 12px;
        font-size: 12px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        background-color: #ffffff;
        color: #333333;
        box-sizing: border-box;
        min-height: 120px;
        resize: vertical;
      }

      .file-upload {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #ffffff;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 10px;
        cursor: pointer;
      }

      .check-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .check-group input {
        margin-right: 8px;
      }

      .check-group label {
        display: inline;
        margin-bottom: 0;
      }

      button {
        background-color: #0d99ff;
        color: white;
        border: none;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
        width: 100%;
      }

      button:hover {
        opacity: 0.9;
      }

      button:disabled {
        background-color: #e5e5e5;
        cursor: not-allowed;
      }

      .button-secondary {
        background-color: transparent;
        color: #333333;
        border: 1px solid #e5e5e5;
        margin-top: 8px;
      }

      .status {
        font-size: 12px;
        margin-top: 16px;
        text-align: center;
      }

      .tabs {
        display: flex;
        margin-bottom: 16px;
        border-bottom: 1px solid #e5e5e5;
      }

      .tab {
        padding: 8px 16px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
      }

      .tab.active {
        border-bottom: 2px solid #0d99ff;
        font-weight: 500;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .loading {
        display: none;
        justify-content: center;
        margin-top: 20px;
      }

      .spinner {
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 3px solid #0d99ff;
        width: 20px;
        height: 20px;
      }

      .input-row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .input-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .action-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: 8px 12px;
        font-size: 12px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        background-color: #ffffff;
        color: #333333;
        box-sizing: border-box;
      }

      .file-input {
        display: none;
      }

      .note {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>HTML to Figma Converter</h2>

      <div class="tabs">
        <div class="tab active" data-tab="json-tab">JSON</div>
        <div class="tab" data-tab="options-tab">Options</div>
      </div>

      <div class="tab-content active" id="json-tab">
        <div class="form-group">
          <label for="jsonData">Paste your JSON data from HTML parser</label>
          <div class="textarea-wrapper">
            <textarea
              id="jsonData"
              placeholder='Paste Figma JSON like:\n{\n  "frames": [\n    {\n      "id": "heroSection",\n      "name": "Hero Section",\n      "type": "FRAME",\n      "x": 0,\n      "y": 0,\n      "width": 1200,\n      "height": 600,\n      "backgroundColor": { "r": 1, "g": 1, "b": 1 },\n      "children": [...]\n    }\n  ]\n}'
              rows="15"
            ></textarea>
            <label for="jsonFile" class="file-upload">Upload JSON</label>
            <input
              type="file"
              id="jsonFile"
              class="file-input"
              accept=".json"
            />
          </div>
          <div class="note">
            Paste Figma-style JSON or HTML-derived JSON. This plugin supports
            both formats!<br />
            <strong>Note:</strong> Frames with light background colors may
            appear as black outlines only on white pages. Select them in the
            layers panel to adjust colors.
          </div>
        </div>
      </div>

      <div class="tab-content" id="options-tab">
        <div class="check-group">
          <input type="checkbox" id="preserveColors" checked />
          <label for="preserveColors">Preserve colors</label>
        </div>

        <div class="check-group">
          <input type="checkbox" id="preserveTextStyles" checked />
          <label for="preserveTextStyles">Preserve text styles</label>
        </div>

        <div class="check-group">
          <input type="checkbox" id="useAutoLayout" checked />
          <label for="useAutoLayout">Use Auto Layout</label>
        </div>

        <div class="check-group">
          <input type="checkbox" id="flattenDivs" />
          <label for="flattenDivs">Flatten empty divs</label>
        </div>

        <div class="check-group">
          <input type="checkbox" id="extractComponents" />
          <label for="extractComponents"
            >Extract repeated elements as components</label
          >
        </div>

        <div class="check-group">
          <input type="checkbox" id="autoRun" />
          <label for="autoRun">Auto-run on open (when sample is loaded)</label>
        </div>

        <div class="form-group">
          <label for="defaultFontFamily">Default Font Family</label>
          <input type="text" id="defaultFontFamily" value="Inter" />
        </div>

        <div class="input-row">
          <div class="form-group">
            <label for="viewportWidth">Viewport Width</label>
            <input type="number" id="viewportWidth" value="1440" />
          </div>
          <div class="form-group">
            <label for="viewportHeight">Viewport Height</label>
            <input type="number" id="viewportHeight" value="900" />
          </div>
        </div>
      </div>

      <div class="action-row">
        <button id="convertBtn">Convert to Figma</button>
        <button id="runNowBtn">Run now</button>
      </div>
      <button id="cancelBtn" class="button-secondary">Cancel</button>

      <div class="loading" id="loadingIndicator">
        <div class="spinner"></div>
      </div>

      <div class="status" id="statusMessage"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Tab switching functionality
        const tabs = document.querySelectorAll(".tab");
        const tabContents = document.querySelectorAll(".tab-content");

        tabs.forEach((tab) => {
          tab.addEventListener(
            "click",
            function () {
              // Remove active class from all tabs and contents
              tabs.forEach((t) => t.classList.remove("active"));
              tabContents.forEach((c) => c.classList.remove("active"));

              // Add active class to current tab and content
              this.classList.add("active");
              document.getElementById(this.dataset.tab).classList.add("active");
            },
            { passive: true }
          );
        });

        // File upload handling
        const jsonFileInput = document.getElementById("jsonFile");
        const jsonDataTextarea = document.getElementById("jsonData");
        const autoRunCheckbox = document.getElementById("autoRun");

        // Track if the user has uploaded/edited the textarea to avoid
        // the bundled sample overwriting their file.
        let userProvidedJson = false;

        // Restore auto-run preference from localStorage (default: enabled)
        try {
          const saved = localStorage.getItem("autoRunEnabled");
          if (saved !== null) {
            autoRunCheckbox.checked = saved === "true";
          } else {
            autoRunCheckbox.checked = true;
          }
        } catch (e) {
          // Ignore storage errors
          autoRunCheckbox.checked = true;
        }

        autoRunCheckbox.addEventListener("change", function (e) {
          try {
            localStorage.setItem(
              "autoRunEnabled",
              this.checked ? "true" : "false"
            );
          } catch (err) {
            // ignore
          }
        });

        jsonFileInput.addEventListener(
          "change",
          function (event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const contents = e.target.result;
                jsonDataTextarea.value = contents;
                // Mark that the user provided content so the startup sample
                // won't overwrite it.
                userProvidedJson = true;
                statusMessage.textContent =
                  "File loaded. Click Convert or Run now.";
              };
              reader.readAsText(file);
            }
          },
          { passive: true }
        );

        // If the user types/pastes into the textarea, treat that as user-provided
        // content so the bundled sample won't overwrite it later.
        jsonDataTextarea.addEventListener(
          "input",
          function () {
            userProvidedJson = true;
          },
          { passive: true }
        );

        // Form submission
        const convertBtn = document.getElementById("convertBtn");
        const runNowBtn = document.getElementById("runNowBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const statusMessage = document.getElementById("statusMessage");

        convertBtn.addEventListener(
          "click",
          function () {
            const jsonData = jsonDataTextarea.value;

            if (!jsonData) {
              statusMessage.textContent =
                "Please paste JSON data or upload a JSON file.";
              return;
            }

            try {
              // Parse the JSON data
              const parsedData = JSON.parse(jsonData);

              // Get options
              const options = {
                preserveColors:
                  document.getElementById("preserveColors").checked,
                preserveTextStyles:
                  document.getElementById("preserveTextStyles").checked,
                useAutoLayout: document.getElementById("useAutoLayout").checked,
                flattenDivs: document.getElementById("flattenDivs").checked,
                extractComponents:
                  document.getElementById("extractComponents").checked,
                defaultFontFamily:
                  document.getElementById("defaultFontFamily").value,
                viewportWidth: parseInt(
                  document.getElementById("viewportWidth").value
                ),
                viewportHeight: parseInt(
                  document.getElementById("viewportHeight").value
                ),
              };

              // Show loading state
              convertBtn.disabled = true;
              if (runNowBtn) runNowBtn.disabled = true;
              loadingIndicator.style.display = "flex";
              statusMessage.textContent = "Converting JSON to Figma...";

              // Send data to plugin code
              parent.postMessage(
                {
                  pluginMessage: {
                    type: "convert-json",
                    jsonData: parsedData,
                    options,
                  },
                },
                "*"
              );
            } catch (error) {
              statusMessage.textContent =
                "Error parsing JSON: " + error.message;
            }
          },
          { passive: true }
        );

        cancelBtn.addEventListener(
          "click",
          function () {
            parent.postMessage({ pluginMessage: { type: "cancel" } }, "*");
          },
          { passive: true }
        );

        // Quick-run button (does the same as Convert but keeps the UI flow clear)
        if (runNowBtn) {
          runNowBtn.addEventListener(
            "click",
            function () {
              const jsonData = jsonDataTextarea.value;
              if (!jsonData) {
                statusMessage.textContent =
                  "Please paste JSON data or upload a JSON file.";
                return;
              }

              try {
                const parsedData = JSON.parse(jsonData);
                const options = {
                  preserveColors:
                    document.getElementById("preserveColors").checked,
                  preserveTextStyles:
                    document.getElementById("preserveTextStyles").checked,
                  useAutoLayout:
                    document.getElementById("useAutoLayout").checked,
                  flattenDivs: document.getElementById("flattenDivs").checked,
                  extractComponents:
                    document.getElementById("extractComponents").checked,
                  defaultFontFamily:
                    document.getElementById("defaultFontFamily").value,
                  viewportWidth: parseInt(
                    document.getElementById("viewportWidth").value
                  ),
                  viewportHeight: parseInt(
                    document.getElementById("viewportHeight").value
                  ),
                };

                // Show quick-run state
                convertBtn.disabled = true;
                runNowBtn.disabled = true;
                loadingIndicator.style.display = "flex";
                statusMessage.textContent = "Running conversion...";

                parent.postMessage(
                  {
                    pluginMessage: {
                      type: "convert-json",
                      jsonData: parsedData,
                      options,
                    },
                  },
                  "*"
                );
              } catch (err) {
                statusMessage.textContent =
                  "Error parsing JSON: " + (err.message || err);
              }
            },
            { passive: true }
          );
        }

        // Listen for messages from the plugin code
        window.onmessage = function (event) {
          const message = event.data.pluginMessage;

          if (message.type === "conversion-complete") {
            convertBtn.disabled = false;
            if (runNowBtn) runNowBtn.disabled = false;
            loadingIndicator.style.display = "none";
            let statusText = `HTML converted to Figma successfully! (${message.created} nodes created)`;
            if (message.rootName) {
              statusText += `\nRoot: "${message.rootName}" (ID: ${message.rootId})`;
            }
            if (message.bounds) {
              statusText += `\nBounds: x=${message.bounds.x}, y=${message.bounds.y}, w=${message.bounds.width}, h=${message.bounds.height}`;
            } else {
              statusText += `\nBounds: null (node may be invisible or off-screen)`;
            }
            statusMessage.textContent = statusText;
          } else if (message.type === "conversion-error") {
            convertBtn.disabled = false;
            if (runNowBtn) runNowBtn.disabled = false;
            loadingIndicator.style.display = "none";
            statusMessage.textContent = "Error: " + message.error;
          } else if (message.type === "load-sample") {
            // If the user already supplied their own JSON, don't overwrite it
            if (userProvidedJson) {
              statusMessage.textContent =
                "User-provided JSON detected â€” keeping your file.";
              return;
            }

            // Pre-fill the textarea with bundled sample JSON (formatted)
            try {
              jsonDataTextarea.value = JSON.stringify(message.jsonData);
            } catch (e) {
              // If message.jsonData is already a string
              jsonDataTextarea.value = message.jsonData || "";
            }

            // Decide whether to auto-run based on the user's preference
            if (!autoRunCheckbox.checked) {
              statusMessage.textContent =
                "Sample loaded. Auto-run is disabled. Click Convert to import.";
            } else {
              statusMessage.textContent =
                "Sample JSON loaded. Auto-running conversion...";

              // Auto-run conversion after a brief delay so UI updates render
              setTimeout(() => {
                const options = {
                  preserveColors:
                    document.getElementById("preserveColors").checked,
                  preserveTextStyles:
                    document.getElementById("preserveTextStyles").checked,
                  useAutoLayout:
                    document.getElementById("useAutoLayout").checked,
                  flattenDivs: document.getElementById("flattenDivs").checked,
                  extractComponents:
                    document.getElementById("extractComponents").checked,
                  defaultFontFamily:
                    document.getElementById("defaultFontFamily").value,
                  viewportWidth: parseInt(
                    document.getElementById("viewportWidth").value
                  ),
                  viewportHeight: parseInt(
                    document.getElementById("viewportHeight").value
                  ),
                };

                try {
                  const parsedData = JSON.parse(jsonDataTextarea.value);
                  parent.postMessage(
                    {
                      pluginMessage: {
                        type: "convert-json",
                        jsonData: parsedData,
                        options,
                      },
                    },
                    "*"
                  );
                } catch (err) {
                  statusMessage.textContent = "Auto-run failed: invalid JSON.";
                }
              }, 350);
            }
          } else if (message.type === "conversion-status") {
            statusMessage.textContent = message.message || "Processing...";
          }
        };
      });
    </script>
  </body>
</html>
